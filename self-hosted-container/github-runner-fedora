# Fedora Github Actions Runner

ARG IMAGE_VERSION=latest

FROM registry.fedoraproject.org/fedora:${IMAGE_VERSION} as base

USER root

RUN useradd fedora
RUN usermod -aG wheel fedora

RUN echo "" >> /root/.bashrc
RUN echo "# Prompt" >> /root/.bashrc
RUN echo export PS1="'\[\e[1;91m\][\u@\h \W]#\[\e[0m\] '" >> /root/.bashrc

RUN dnf upgrade -y --security
RUN dnf group install -y development-tools
RUN dnf install -y hostname wget cmake sqlite-devel device-mapper-devel readline-devel tree shasum uptime which
RUN dnf upgrade -y git || git install -y git
RUN dnf upgrade -y python3 python3-pip || dnf install -y python3 python3-pip
RUN dnf upgrade -y python3.13 || dnf install -y python3.13
RUN dnf upgrade -y python3.14 || dnf install -y python3.14

RUN echo 'PATH="/home/fedora/.local/bin:/usr/local/bin:/usr/bin"' >> /etc/environment

USER fedora

RUN sed -i".orig" -e 's/ls -la/ls -la --color=always/g' /home/fedora/.bashrc
RUN echo "" >> /home/fedora/.bashrc
RUN echo "" >> /home/fedora/.bashrc
RUN echo "# Prompt" >> /home/fedora/.bashrc
RUN echo export PS1="'\[\e[1;92m\][\u@\h \W]$\[\e[0m\] '" >> /home/fedora/.bashrc
RUN cp /home/fedora/.bashrc /home/fedora/.bash_profile
RUN pip install requests

RUN [[ ! -d /home/fedora/.vim ]] && mkdir -p /home/fedora/.vim

WORKDIR /home/fedora

RUN mkdir /home/fedora/actions-runner
RUN mkdir /home/fedora/private

COPY runner.env /home/fedora/actions-runner/
COPY build-runner.sh /home/fedora/actions-runner/
COPY configure-run-runner.sh /home/fedora/actions-runner/
COPY --chmod=755 runner-tools /home/fedora/actions-runner/

# Install the runner software and prep for configuration
RUN /home/fedora/actions-runner/build-runner.sh

USER root
RUN /home/fedora/actions-runner/bin/installdependencies.sh

USER fedora

# Copy peronal access token temporarily for the configuration step
COPY github-personal-access-token.env /home/fedora/private/

# Configure the runner with the registration token
CMD /home/fedora/actions-runner/configure-run-runner.sh

